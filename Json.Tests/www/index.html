<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Test page for Json.Fliox.DB server to send server commands via WebSocket's">
    <meta name="color-scheme" content="dark light">
    <link rel="icon" href="/Json-Fliox-53x43.svg" type="image/x-icon">
    <title>Json.Fliox.DB server</title>

    <script>
        var connection;
        var websocketCount = 0;
        var reqId = 1;

        function connectWebsocket() {
            var loc             = window.location;
            var uri             = `ws://${loc.host}/websocket-${++websocketCount}`;
            var socketStatus    = document.getElementById("socketStatus");
            try {
                connection = new WebSocket(uri);
            } catch (err) {
                socketStatus.innerText = "connect failed: err";
                return;
            }
            connection.onopen = function () {
                socketStatus.innerText = "connected 🟢";
                console.log('WebSocket connected');
                reqId = 1;
            };

            connection.onclose = function (e) {
                socketStatus.innerText = "closed. code: " + e.code;
                console.log('WebSocket closed');
            };

            // Log errors
            connection.onerror = function (error) {
                socketStatus.innerText = "error";
                console.log('WebSocket Error ' + error);
            };

            // Log messages from the server
            connection.onmessage = function (e) {
                // var data = JSON.parse(e.data);
                // console.log('server:', e.data);
                var jsonRequest = document.getElementById("jsonResponse").value = e.data;
            };

        }

        function closeWebsocket() {
            connection.close();
        }

        function sendSyncRequest() {
            var reqIdElement = document.getElementById("reqId");
            if (!connection || connection.readyState != 1) { // 1 == OPEN {
                reqIdElement.innerText = "n/a (Request failed. WebSocket not connected)";
                return;
            }
            var jsonRequest = document.getElementById("jsonRequest").value;
            try {
                var request = JSON.parse(jsonRequest);
                request.reqId = reqId;
                jsonRequest = JSON.stringify(request);                
            } catch { }
            connection.send(jsonRequest);
            reqIdElement.innerText = reqId;
            reqId++;
        }

        async function onExampleChange() {
            var selectElement = document.getElementById("example");
            var exampleName = selectElement.value;
            if (exampleName == "")
                return;
            var response = await fetch(exampleName);
            var example = await response.text();
            document.getElementById("jsonRequest").value = example;
        }

        (async() => {
            var folder = './example-requests'
            var response = await fetch(folder);
            var exampleRequests = await response.json();
            var selectElement = document.getElementById("example");
            var exampleGroup = "0";
            for (var example of exampleRequests) {
                if (!example.endsWith(".json"))
                    continue;
                var name = example.substring(folder.length);
                if (exampleGroup != name[0]) {
                    selectElement.add(document.createElement("option"));
                    exampleGroup = name[0];
                }
                var option = document.createElement("option");
                option.value    = example;
                option.text     = name;
                selectElement.add(option);
            }
        })();


    </script>
    <style>
        a               { text-decoration:  none; }
        tr              { vertical-align:   top; }
        button          { width:            80px;}
        .inline         { display:          inline; }
        h2              { display:          inline;  }
        textarea        { white-space:      pre;  }
        .alignBottom    { vertical-align:   bottom; }
        .nobreak        { white-space:      pre; }
    </style>
    <link
    rel="stylesheet"
    data-name="vs/editor/editor.main"
    href="https://microsoft.github.io/monaco-editor/node_modules/monaco-editor/min/vs/editor/editor.main.css"
/>
</head>

<body style="font-family: sans-serif">
  <table>
    <tr>
      <td><a href="https://github.com/friflo/Friflo.Json.Fliox/blob/main/Json.Tests/Main/Program.cs" target='_blank' rel='noopener'><img src='/Json-Fliox-53x43.svg' alt="friflo JSON Fliox"></a></td>
      <td>&nbsp;&nbsp;&nbsp;</td>
      <td class="alignBottom"><h2>Json.Fliox.DB server</h2>
    </tr>
    <tr>
      <td></td>
      <td></td>
      <td>⊳ <a href="./schema/index.html">schema</a></td>
    </tr>
  </table>
  <p class="nobreak">This server is a 'Hello World' example to demonstrate its database access, messaging and Pub-Sub capabilities.</p> 

  Websocket &nbsp;&nbsp;
  <button type="button" onclick="connectWebsocket()">Connect</button> 
  <button type="button" onclick="closeWebsocket()">Close</button> &nbsp;&nbsp;
  status: <div id="socketStatus" class="inline">disconnected</div>
  <br><br>

  <table>
    <tr>
      <td>Request &nbsp;&nbsp;<select title="example-requests" id="example" onchange="onExampleChange()"></select></td>
      <td>Response *</td>
    </tr>
    <tr>
      <td>
        <div id="container" style="width: 400px; height: 400px; border: 1px solid grey"></div>
        
        <button type="button" onclick="sendSyncRequest()">Send sync</button> &nbsp;&nbsp;
        reqId: <div id="reqId" class="inline">n/a</div>
      </td>
      <td>
        <textarea id="jsonResponse" title="Response received fom host" cols="60" rows="25"></textarea><br>
        <small>* all messages: DevTools > Network > websocket-* > Messages</small>
      </td>
    </tr>
  </table>
<script>
    var require = { paths: { vs: 'https://microsoft.github.io/monaco-editor/node_modules/monaco-editor/min/vs' } };
</script>
<script src="https://microsoft.github.io/monaco-editor/node_modules/monaco-editor/min/vs/loader.js"></script>
<script src="https://microsoft.github.io/monaco-editor/node_modules/monaco-editor/min/vs/editor/editor.main.nls.js"></script>
<script src="https://microsoft.github.io/monaco-editor/node_modules/monaco-editor/min/vs/editor/editor.main.js"></script>

<script>
async function setupMonaco() {
    var jsonCode = [
        '{',
        '    "p1": "v3",',
        '    "p2": false',
        "}"
    ].join('\n');

    var modelUri = monaco.Uri.parse("request://b/foo.json"); // a made up unique URI for our model
    var model = monaco.editor.createModel(jsonCode, "json", modelUri);

    // configure the JSON language support with schemas and schema associations
    var schemaUrlsResponse  = await fetch("/schema/json-schema/directory");
    var schemaUrls          = await schemaUrlsResponse.json();
    /* var schemas = [{
            uri: "http://myserver/foo-schema.json", // id of the first schema
            // fileMatch: [modelUri.toString()], // associate with our model
            schema: {
                type: "object",
                properties: {
                    p1: {
                        enum: ["v1", "v2"]
                    },
                    p2: {
                        $ref: "http://myserver/bar-schema.json" // reference the second schema
                    }
                }
            }
        }, {
            uri: "http://myserver/bar-schema.json", // id of the second schema
            schema: {
                type: "object",
                properties: {
                    q1: {
                        enum: ["x1", "x2"]
                    }
                }
            }
        }]; */
    var schemas = [];
    for (let i = 0; i < schemaUrls.length; i++) {
        var schemaName      = schemaUrls[i]
        var url             = "/schema/json-schema/" + schemaName;
        var schemaResponse  = await fetch(url);
        var schema          = await schemaResponse.json();
        var schemaEntry = {
            uri:    "http:/" + url,
            schema: schema            
        }
        schemas.push(schemaEntry);
        if (schemaName == "UnitTest.Fliox.Client.Order.json") {
            schemaEntry.fileMatch = [modelUri.toString()]; // associate with our model
        }
    }

    monaco.languages.json.jsonDefaults.setDiagnosticsOptions({
        validate: true,
        schemas: schemas
    });

    monaco.editor.create(document.getElementById("container"), {
        model: model
    });
}
setupMonaco();
</script>
</body>
</html>